(()=>{"use strict";class e{constructor(){this.init()}init(){const e=document.querySelector(".send-app-admin-app");e.classList.add("esend-app");const t=document.createElement("iframe");t.classList.add("esend-iframe"),t.setAttribute("allow","clipboard-write; fullscreen"),t.setAttribute("allowfullscreen","true");let a=null;if(localStorage.getItem("refresh")){const e=localStorage.getItem("route");a=e?`${eSendAdminAppConfig.iframeUrl}${e}`:eSendAdminAppConfig.iframeUrl,localStorage.removeItem("refresh")}else a=eSendAdminAppConfig.iframeUrl;const s=new URL(a);s.searchParams.set("t",(new Date).getTime()),t.src=s.toString(),e.appendChild(t),this.iframe=t}sendMessage(e,t="*"){const a=window.location.hostname;this.iframe.contentWindow.postMessage({message:e,domain:a},t)}}!function(){class t{constructor(){this.iframe=new e,this.init()}static getInstance(){return t.instance||(t.instance=new t),t.instance}init(){this.initEventListeners()}async getSiteConfig(e="get-site-config"){const t={streamName:e,data:this.getInitData()};this.sendMessage(t,"*")}async reconnect(){await this.streamData(["connect/reconnect","*"],"POST")}async authorize(){const e=await this.streamData(["connect/authorize","*"],"POST");e.data&&window.open(e.data,"_self")}async switchDomain(){const e=await this.streamData(["connect/switch_domain","*"],"POST");e.data&&window.open(e.data,"_self")}async sendHeaderData(){await this.streamData(["connect/refresh-token","*"],"POST")}async handleGetGallery(e){const t=e;let a="gallery-images";if(t&&Object.keys(t).length>0){const e=new URLSearchParams;t.search?.trim()&&e.append("search",t.search),t.per_page&&e.append("per_page",t.per_page.toString()),t.page&&e.append("page",t.page.toString());const s=e.toString();s&&(a+="?"+s)}await this.streamData([a,"*"],"GET",{},{},"gallery-images")}refreshListener(){document.addEventListener("DOMContentLoaded",(()=>{const[e]=performance.getEntriesByType("navigation");e&&"reload"===e.type&&localStorage.setItem("refresh","true")}))}closeListener(){window.addEventListener("unload",(()=>{localStorage.getItem("refresh")||this.resetLocalStorage()}))}initEventListeners(){this.refreshListener(),this.closeListener(),window.addEventListener("message",(async e=>{const{message:t,data:a}=e.data;switch(t){case"get-site-config":await this.getSiteConfig();break;case"connect/reconnect":await this.reconnect();break;case"connect/switch-domain":await this.switchDomain();break;case"connect/authorize":await this.authorize();break;case"get-integrations":await this.streamData(["integrations","*"]);break;case"get-integrations-status":await this.streamData(["get-integrations-status","*"]);break;case"get-forms":await this.streamData(["forms","*"]);break;case"integrations/forms/all":await this.streamData(["integrations/forms/all","*"]);break;case"integrations-disconnect":await this.streamData([`integrations/${a}/disconnect`,"*"],"POST",{sourceNameId:a});break;case"integrations-connect":await this.streamData([`integrations/${a}/connect`,"*"],"POST",{sourceNameId:a});break;case"connect-plugin":await this.streamData(["connect-plugin","*"],"POST",{sourceNameId:a});break;case"get-forms-list-by-source-id":await this.streamData([`integrations/${a}/forms`,"*"],"GET",{},{},t);break;case"gallery-images":await this.handleGetGallery(a);break;case"activate-form-tracking":await this.streamData([`integrations/${a.sourceNameId}/forms/${a.formId}`,"*"],"POST",{trackingEnabled:a.status},{},t);break;case"activate-plugin":await this.streamData(["activate-plugin","*"],"POST",{sourceNameId:a});break;case"create-plugin-forms":await this.streamData(["create-plugin-forms","*"],"POST");break;case"sync-woo":await this.streamData(["sync-woo","*"]);break;case"set-current-path":localStorage.setItem("route",a);break;case"connect/refresh-token":await this.sendHeaderData();break;default:console.warn("Unknown request from plugin iframe (react app):",t)}}))}getStreamNames(){return[["integrations","*"],["forms","*"],["deactivate-plugin","*"],["activate-plugin","*"]]}async streamData(e,t="GET",a={},s={},n=""){s={"X-WP-Nonce":eSendAdminAppConfig.nonce,"Content-Type":"application/json",...eSendAdminAppConfig.headers};const r=await this.fetchStreamData(e[0],t,a,s);return r.streamName=e[0],""!==n&&(r.streamName=n),this.sendMessage(r,"*"),r}sendMessage(e,t="*"){this.iframe.sendMessage(e,t)}resetLocalStorage(){localStorage.removeItem("refresh"),localStorage.removeItem("route")}getInitData(){return eSendAdminAppConfig}async fetchStreamData(e,t="GET",a=null,s=null){const n={url:`${eSendAdminAppConfig.baseRestUrl}e-send/v1/${e}`,method:t};s&&(n.headers=s),"POST"===t.toUpperCase()&&a&&(n.data=JSON.stringify(a));try{return await jQuery.ajax(n)}catch(t){throw this.sendMessage({error:t?.statusText||"error",data:`Failed to fetch data for stream ${e}`}),t}}}t.getInstance()}()})();